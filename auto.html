<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMOCARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* --- 1. å°é¢ä¸å¼¹çª—æ ·å¼ --- */
        .ripple { 
            position: absolute; width: 100px; height: 100px; 
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; 
            animation: ripple-effect 2.5s infinite; z-index: 4000; 
        }
        @keyframes ripple-effect { 
            0% { transform: scale(1); opacity: 0.8; } 
            100% { transform: scale(2.2); opacity: 0; } 
        }

        #confirm-layer { 
            position: fixed; inset: 0; z-index: 20000; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; 
        }
        .confirm-card { 
            width: 85%; max-width: 320px; background: rgba(255,255,255,0.08); 
            padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); text-align: center; 
        }
        
        /* --- 2. åŸºç¡€å¸ƒå±€ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; }
        
        #setup-layer { position: fixed; inset: 0; z-index: 10000; background: #1a1a1a; display: none; align-items: center; justify-content: center; transition: 0.8s ease; }
        .setup-card { width: 85%; max-width: 400px; color: white; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 30px; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .input-box { margin-bottom: 20px; }
        .input-box label { display: block; font-size: 10px; opacity: 0.6; margin-bottom: 8px; text-transform: uppercase; }
        .input-box input, .input-box textarea { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: white; outline: none; }
        .generate-btn { width: 100%; padding: 16px; border-radius: 15px; border: none; background: #fff; color: #000; font-weight: 600; cursor: pointer; }

        /* --- 3. æ ¸å¿ƒäº¤äº’ç»„ä»¶ --- */
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { 
            width: 76px; height: 76px; border-radius: 50%; background: rgba(255,255,255,0.1); overflow: hidden; 
            transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); cursor: pointer; pointer-events: auto; z-index: 4001; 
            border: 2px solid rgba(255,255,255,0.2); 
        }
        body.state-hero .main-avatar { width: 280px; height: 280px; transform: translateY(-60px); }

        .hero-text-block { position: absolute; top: 50%; left: 0; width: 100%; padding-top: 100px; text-align: center; color: white; transition: 0.7s ease; pointer-events: none; opacity: 0; transform: translateY(20px); }
        body.state-hero .hero-text-block { opacity: 1; transform: translateY(0); }

        /* ä¿®å¤æ˜¾ç¤ºé—®é¢˜ï¼šè®© stage é»˜è®¤åœ¨ ready çŠ¶æ€ä¸‹æ˜¾ç¤º */
        #stage, #lineCanvas { position: fixed; inset: 0; transition: opacity 1.2s ease; opacity: 0; pointer-events: none; }
        body.ready #stage, body.ready #lineCanvas { opacity: 1; pointer-events: auto; }
        
        /* å…³é”®ï¼šåœ¨å¤§å›¾æ¨¡å¼ä¸‹é™ä½æ°”æ³¡å±‚çº§æˆ–é€æ˜åº¦ï¼Œé¿å…é®æŒ¡ */
        body.state-hero #stage { opacity: 0.3; pointer-events: none; }

        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-size: cover; background-position: center; transform: scale(1.8); filter: blur(60px) brightness(0.4); }

        /* --- 4. æ°”æ³¡ä¸æ–‡å­—æˆªæ–­ --- */
        .bubble { 
            position: absolute; border-radius: 50%; width: 120px; height: 120px; 
            background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; 
            display: flex; align-items: center; justify-content: center; will-change: transform; z-index: 3000; 
            opacity: 0; transition: opacity 1s; overflow: hidden;
        }
        .bubble.spawned { opacity: 1; }

        .bubble.is-text {
            /* è§£å†³æ–‡å­—æº¢å‡ºï¼šé™åˆ¶åœ¨ 80% åŒºåŸŸå†…å¹¶ä½¿ç”¨çœç•¥å· */
            padding: 0;
            width: 80%;
            height: 80%;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 4; /* æœ€å¤š4è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
            font-size: 11px;
            text-align: center;
            line-height: 1.4;
            word-break: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        /* å¦‚æœæ˜¯ Flex å¸ƒå±€ï¼Œline-clamp éœ€è¦åŒ…è£¹ä¸€å±‚ */
        .bubble-inner-text {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 4;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bubble.is-img img { width: 100%; height: 100%; object-fit: cover; }
        .unread-dot { position: absolute; top: 15px; right: 15px; width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; }

        /* å…¶ä»–åŸæœ‰æ ·å¼ä¿æŒ... */
        #modal-overlay { position: fixed; inset: 0; z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(40px); background: rgba(0,0,0,0.3); opacity: 0; transition: 0.4s; }
        #modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { background: white; padding: 30px; border-radius: 30px; width: 85%; max-width: 320px; text-align: center; }
        #top-notif { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: #fff; padding: 12px 20px; border-radius: 40px; z-index: 5000; transition: 0.5s; }
        #top-notif.active { transform: translateX(-50%) translateY(100px); }
        #reset-trigger { position: fixed; top: 20px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-cover">
        <div class="avatar-wrapper" onclick="enterSetup()" style="cursor: pointer; display: flex; flex-direction: column; align-items: center;">
            <div class="ripple"></div><div class="ripple"></div>
            <div class="main-avatar" style="width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 30px;">ğŸŒ±</span>
            </div>
            <div style="margin-top: 30px; font-size: 10px; color: rgba(255,255,255,0.5); letter-spacing: 2px;">TAP TO START</div>
        </div>
    </div>

    <div id="setup-layer">
        <div class="setup-card">
            <h2 style="margin-bottom:20px;">Memory Setting</h2>
            <div class="input-box"><label>Object Image</label><input type="file" id="upload-img" accept="image/*"></div>
            <div class="input-box"><label>Object Name</label><input type="text" id="input-name" placeholder="Name..."></div>
            <div class="input-box"><label>Description</label><textarea id="input-desc" rows="3" placeholder="Description..."></textarea></div>
            <button class="generate-btn" onclick="applyCustomization()">Save</button>
        </div>
    </div>

    <button id="reset-trigger" onclick="location.reload()">RESET</button>
    <div id="top-notif"><span id="notif-text" style="font-size: 12px; color: #333;">A new memory arrives...</span></div>
    <div class="bg-glass"></div>
    <canvas id="lineCanvas"></canvas>

    <div class="center-hub">
        <div class="main-avatar" onclick="document.body.classList.toggle('state-hero')"><img id="display-avatar" src=""></div>
        <div class="hero-text-block">
            <h1 id="display-name"></h1>
            <p id="display-date" style="font-size: 12px; opacity: 0.5; margin: 10px 0;"></p>
            <p id="display-desc" style="font-size: 14px; opacity: 0.8; max-width: 80%; margin: 0 auto;"></p>
        </div>
    </div>
    
    <div id="stage"></div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="m-visual"></div>
            <p id="m-text" style="color: #333; font-size: 14px; line-height: 1.5;"></p>
        </div>
    </div>

    <script>
        let bubbles = [];
        let draggedBubble = null;
        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');

        function enterSetup() {
            document.getElementById('start-cover').style.display = 'none';
            document.getElementById('setup-layer').style.display = 'flex';
        }

        function applyCustomization() {
            const fileInput = document.getElementById('upload-img');
            const name = document.getElementById('input-name').value;
            if (!fileInput.files[0] || !name) return alert("Image and Name required");

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('setup-layer').style.display = 'none';
                document.getElementById('display-avatar').src = e.target.result;
                document.getElementById('display-name').innerText = name;
                document.getElementById('display-desc').innerText = document.getElementById('input-desc').value || "No description.";
                document.getElementById('display-date').innerText = new Date().toLocaleDateString().toUpperCase();
                document.querySelector('.bg-glass').style.backgroundImage = `url(${e.target.result})`;

                document.body.classList.add('ready');
                initPhysics();
                startDemoSequence();
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        function startDemoSequence() {
            const msgs = [
                { type: 'text', content: "Someone picked it up! Your plant has a new home." },
                { type: 'img', content: "Itâ€™s all settled in on my desk.", rawImg: "https://picsum.photos/id/28/400/400" },
                { type: 'text', content: "This is a very long message to test if the ellipsis and text truncation logic is working correctly inside the bubble." }
            ];
            
            msgs.forEach((m, i) => {
                setTimeout(() => {
                    createBubble(m);
                    showNotif();
                }, i * 3000);
            });
        }

        function showNotif() {
            const n = document.getElementById('top-notif');
            n.classList.add('active');
            setTimeout(() => n.classList.remove('active'), 3000);
        }

        function createBubble(data) {
            const el = document.createElement('div');
            el.className = `bubble is-${data.type}`;
            
            if(data.type === 'text') {
                el.innerHTML = `<div class="unread-dot"></div><div class="bubble.is-text"><div class="bubble-inner-text">${data.content}</div></div>`;
            } else {
                el.innerHTML = `<div class="unread-dot"></div><img src="${data.rawImg}">`;
            }

            stage.appendChild(el);
            const bObj = setupPhysics(el, data);
            bubbles.push(bObj);
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        function setupPhysics(el, data) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const bObj = { el, x: ww/2-60, y: wh/2-60, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, isDragged: false, data };
            
            el.addEventListener('mousedown', () => { draggedBubble = bObj; bObj.isDragged = true; });
            el.addEventListener('touchstart', (e) => { draggedBubble = bObj; bObj.isDragged = true; });
            
            // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
            el.onclick = () => { if(Math.abs(bObj.vx) < 1) openModal(bObj); };
            
            return bObj;
        }

        function openModal(b) {
            document.getElementById('m-text').innerText = b.data.content;
            document.getElementById('m-visual').innerHTML = b.data.rawImg ? `<img src="${b.data.rawImg}" style="width:100%; border-radius:15px; margin-bottom:15px;">` : "";
            document.getElementById('modal-overlay').style.display = 'flex';
            setTimeout(() => document.getElementById('modal-overlay').classList.add('active'), 10);
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            setTimeout(() => document.getElementById('modal-overlay').style.display = 'none', 400);
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const ww = window.innerWidth, wh = window.innerHeight;
            const cx = ww/2, cy = wh/2;

            bubbles.forEach((b, i) => {
                if (!b.isDragged) {
                    // ç®€å•çš„å‘å¿ƒå¼•åŠ›
                    b.vx += (cx - (b.x+60)) * 0.0001;
                    b.vy += (cy - (b.y+60)) * 0.0001;
                    b.vx *= 0.95; b.vy *= 0.95;
                    b.x += b.vx; b.y += b.vy;
                }
                // è¾¹ç•Œæ£€æŸ¥
                b.x = Math.max(0, Math.min(ww-120, b.x));
                b.y = Math.max(0, Math.min(wh-120, b.y));
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });
            requestAnimationFrame(animate);
        }

        function initPhysics() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            animate();
        }

        window.addEventListener('mousemove', e => { if(draggedBubble){ draggedBubble.x=e.clientX-60; draggedBubble.y=e.clientY-60; } });
        window.addEventListener('touchmove', e => { if(draggedBubble){ draggedBubble.x=e.touches[0].clientX-60; draggedBubble.y=e.touches[0].clientY-60; } });
        window.addEventListener('mouseup', () => { if(draggedBubble) draggedBubble.isDragged = false; draggedBubble = null; });
        window.addEventListener('touchend', () => { if(draggedBubble) draggedBubble.isDragged = false; draggedBubble = null; });
    </script>
</body>
</html>
