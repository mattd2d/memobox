<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BAMBOO FLOW - SENDER</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* --- 样式补全：确保不是白屏 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        body { background: #1a1a1a; font-family: 'Poppins', sans-serif; overflow: hidden; height: 100vh; width: 100vw; touch-action: none; color: white; }
        #stage { position: absolute; inset: 0; z-index: 2500; pointer-events: none; }
        #lineCanvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        .bg-glass { position: fixed; inset: 0; z-index: -1; background: #222; background-position: center; background-size: cover; transform: scale(1.8); filter: blur(60px) brightness(0.4); }
        .center-hub { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; pointer-events: none; }
        .main-avatar { width: 76px; height: 76px; border-radius: 50%; background: rgba(255,255,255,0.1); overflow: hidden; z-index: 4001; pointer-events: auto; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); }
        .main-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .bubble { position: absolute; border-radius: 50%; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); cursor: grab; pointer-events: auto; opacity: 0; display: flex; align-items: center; justify-content: center; will-change: transform, opacity; z-index: 3000; }
        .bubble.spawned { opacity: 1; transition: opacity 0.5s ease-out; }
        .bubble.is-text { padding: 18px; font-size: 11px; color: rgba(255,255,255,0.8); text-align: center; line-height: 1.4; }
        .bubble.is-status { background: #ffffff; border: none; color: #000; font-weight: 700; text-transform: uppercase; font-size: 10px; }
        .bubble.is-plus { border: 2px dashed rgba(255,255,255,0.3); background: none; font-size: 30px; color: white; cursor: pointer; }
        #menu-layer { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .menu-card { width: 85%; max-width: 350px; color: white; background: #222; padding: 25px; border-radius: 25px; border: 1px solid #333; }
        .input-box { margin-bottom: 15px; }
        .input-box label { display: block; font-size: 10px; opacity: 0.5; margin-bottom: 5px; }
        .input-box input, .input-box textarea { width: 100%; background: #333; border: none; border-radius: 10px; padding: 12px; color: white; outline: none; font-family: inherit; }
        .send-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: white; font-weight: 600; cursor: pointer; }
        #reset-btn { position: fixed; top: 20px; right: 20px; z-index: 5000; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="bg-glass" id="bg-img"></div>
    <canvas id="lineCanvas"></canvas>
    <button id="reset-btn" onclick="clearAll()">RESET</button>

    <div class="center-hub">
        <div class="main-avatar" onclick="handleInitialPickup()">
            <img id="display-avatar" src="">
        </div>
    </div>

    <div id="stage"></div>

    <div id="menu-layer" onclick="this.style.display='none'">
        <div class="menu-card" onclick="event.stopPropagation()">
            <div class="input-box"><label>MESSAGE</label><textarea id="msg-text" rows="3"></textarea></div>
            <div class="input-box"><label>IMAGE (OPTIONAL)</label><input type="file" id="msg-img" accept="image/*"></div>
            <button class="send-btn" onclick="handleNormalSend()">SEND</button>
        </div>
    </div>

    <script>
        // --- 2. 注入你的配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7OLP-hG6ekdLQewLrB9BFGQCuzRlbnTE",
            authDomain: "memo-6a74a.firebaseapp.com",
            projectId: "memo-6a74a",
            storageBucket: "memo-6a74a.firebasestorage.app",
            messagingSenderId: "487014379920",
            appId: "1:487014379920:web:aa34c9662846c0a3d60315",
            databaseURL: "https://memo-6a74a-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('flow_messages');

        const stage = document.getElementById('stage');
        const canvas = document.getElementById('lineCanvas');
        const ctx = canvas.getContext('2d');
        let bubbles = [];
        let draggedBubble = null;

        // 加载头像和背景
        window.onload = function() {
            const saved = localStorage.getItem('userObjectData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('display-avatar').src = data.imgData;
                document.getElementById('bg-img').style.backgroundImage = `url(${data.imgData})`;
            }
            initPhysics();
            refreshState();
        };

        // --- 发送逻辑 ---
        function handleInitialPickup() {
            const history = JSON.parse(localStorage.getItem('my_sent_history') || '[]');
            if (history.length === 0) {
                sendData({ mode: 'text', text: "I PICK IT UP", type: 'urgent' }, 
                         { mode: 'text', text: "SOME ONE PICKED IT UP", type: 'urgent' });
            }
        }

        function handleNormalSend() {
            const text = document.getElementById('msg-text').value;
            const file = document.getElementById('msg-img').files[0];
            if (!text && !file) return;
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    sendData({ mode: 'img', img: e.target.result, text, type: 'normal' });
                    document.getElementById('menu-layer').style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                sendData({ mode: 'text', text, type: 'normal' });
                document.getElementById('menu-layer').style.display = 'none';
            }
        }

        function sendData(localPayload, remotePayload = null) {
            const history = JSON.parse(localStorage.getItem('my_sent_history') || '[]');
            history.push(localPayload);
            localStorage.setItem('my_sent_history', JSON.stringify(history));
            db.push(remotePayload || localPayload);
            refreshState();
        }

        function clearAll() {
            localStorage.setItem('my_sent_history', '[]');
            db.set({ clear_all_signal: { type: 'clear_all', time: Date.now() } });
            location.reload();
        }

        function refreshState() {
            bubbles.forEach(b => b.el.remove());
            bubbles = [];
            const history = JSON.parse(localStorage.getItem('my_sent_history') || '[]');
            history.forEach(msg => {
                const el = document.createElement('div');
                const isStatus = msg.text.includes("PICK IT UP");
                el.className = `bubble ${msg.mode === 'img' ? 'is-img' : 'is-text'} ${isStatus ? 'is-status' : ''}`;
                el.innerHTML = msg.mode === 'img' ? `<img src="${msg.img}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : msg.text;
                stage.appendChild(el);
                bubbles.push(setupBubbleObject(el, msg, isStatus));
                requestAnimationFrame(() => el.classList.add('spawned'));
            });
            if (history.length > 0) createPlusBubble();
        }

        function createPlusBubble() {
            const el = document.createElement('div');
            el.className = 'bubble is-plus'; el.innerHTML = '+';
            el.onclick = () => document.getElementById('menu-layer').style.display = 'flex';
            stage.appendChild(el);
            bubbles.push(setupBubbleObject(el, {type:'plus'}, false));
            requestAnimationFrame(() => el.classList.add('spawned'));
        }

        // --- 物理引擎 (1:1 复制) ---
        function setupBubbleObject(el, data, isStatus) {
            const ww = window.innerWidth, wh = window.innerHeight;
            const bObj = { el, x: ww/2-60+Math.random()*20, y: wh/2-60+Math.random()*20, vx: 0, vy: 0, isDragged: false };
            el.ontouchstart = (e) => { draggedBubble = bObj; bObj.isDragged = true; };
            window.ontouchmove = (e) => {
                if (bObj.isDragged) {
                    bObj.x = e.touches[0].clientX - 60;
                    bObj.y = e.touches[0].clientY - 60;
                }
            };
            window.ontouchend = () => { bObj.isDragged = false; draggedBubble = null; };
            return bObj;
        }

        function animate(time) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const ww = window.innerWidth, wh = window.innerHeight, cx = ww / 2, cy = wh / 2;
            ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            bubbles.forEach((b, i) => {
                let px = cx, py = cy;
                if (i > 0) { px = bubbles[i-1].x+60; py = bubbles[i-1].y+60; }
                const currX = b.x+60, currY = b.y+60;
                ctx.moveTo(px, py);
                ctx.quadraticCurveTo((px+currX)/2, (py+currY)/2 + Math.sin(time*0.002+i)*5, currX, currY);
                if (!b.isDragged) {
                    b.vx += (cx - currX) * 0.00002; b.vx *= 0.92; b.vy *= 0.92;
                    b.x += b.vx; b.y += b.vy;
                }
                b.el.style.transform = `translate3d(${b.x}px, ${b.y}px, 0)`;
            });
            ctx.stroke();
            requestAnimationFrame(animate);
        }

        function initPhysics() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; animate(0); }
    </script>
</body>
</html>
